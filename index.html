<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>One Thing</title>
<style>
  :root { --bg:#fafafa; --card:#ffffff; --text:#111; --muted:#6b7280; --line:#eaeaea; --brand:#16a34a; --brandText:#fff; }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:760px;margin:0 auto;padding:20px}
  header{padding:22px 20px;text-align:center;background:#0b57d0;color:#fff}
  header h1{margin:0 0 6px 0;font-size:24px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 1px 0 rgba(0,0,0,.02)}
  .row{display:flex;gap:8px;align-items:center}
  input[type=text]{flex:1;padding:12px 12px;border:1px solid var(--line);border-radius:10px;font-size:16px;outline:none}
  button{border:0;border-radius:10px;padding:12px 14px;font-size:16px;cursor:pointer}
  .primary{background:var(--brand);color:var(--brandText)}
  .ghost{background:#f3f4f6}
  .muted{color:var(--muted)}
  .streak{font-weight:600}
  .tick{display:inline-block;transition:transform .18s ease}
  .tick.pop{transform:scale(1.25)}
  table{width:100%;border-collapse:collapse;font-size:15px}
  th,td{padding:10px 6px;border-bottom:1px solid var(--line);text-align:left}
  th{color:var(--muted);font-weight:600}
  .center{display:flex;gap:12px;justify-content:center;align-items:center}
</style>
</head>
<body>
<header>
  <h1>One Thing</h1>
  <div>It doesnâ€™t tell you what to do â€” it asks what youâ€™ve done. ðŸ’™</div>
</header>

<div class="wrap">

  <!-- First-visit goal prompt -->
  <div class="card" id="goalCard" style="display:none">
    <div class="muted" style="margin-bottom:8px">Whatâ€™s your one goal?</div>
    <div class="row">
      <input id="goalInput" type="text" placeholder="One line (e.g., Close Â£20k sale)" maxlength="80">
      <button class="primary" id="saveGoal">Save</button>
    </div>
  </div>

  <!-- Daily prompt + streak -->
  <div class="card" id="dailyCard" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
      <div class="muted">Goal:</div>
      <div id="goalLabel" style="font-weight:600"></div>
    </div>
    <div class="row" style="margin-bottom:8px">
      <input id="lineInput" type="text" placeholder="How did you move toward your goal today?" maxlength="120">
      <button class="primary" id="logBtn">Log today âœ…</button>
    </div>
    <div class="muted">One line per day. No edits later.</div>
    <div style="margin-top:12px">Streak: <span class="streak" id="streakNum">0</span> day<span id="plural">s</span> <span id="tick" class="tick">âœ…</span></div>
  </div>

  <!-- History (previous days only; shows after logging today) -->
  <div class="card" id="historyCard" style="display:none">
    <table>
      <thead><tr><th style="width:120px">Date</th><th>One line</th></tr></thead>
      <tbody id="historyBody"></tbody>
    </table>
  </div>

  <!-- Goal complete -->
  <div class="center" id="completeWrap" style="display:none;margin:10px 0 26px">
    <button class="primary" id="completeBtn">Goal complete âœ…</button>
  </div>
</div>

<script>
  // ---------- helpers ----------
  const LS = {
    get: (k, f=null) => { try { return JSON.parse(localStorage.getItem(k)) ?? f } catch { return f } },
    set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
    del: (k) => localStorage.removeItem(k)
  };
  const fmt = d => d.toISOString().slice(0,10); // yyyy-mm-dd
  const addDays = (iso, n) => {
    const d = new Date(iso); d.setDate(d.getDate()+n); return fmt(d);
  };

  // ---------- virtual day (advances 1 per refresh for testing) ----------
  let vToday = LS.get('one_vToday');
  if (!vToday) {
    vToday = fmt(new Date()); // start at real today on first load
  } else {
    // advance by 1 day each refresh to simulate new days
    vToday = addDays(vToday, 1);
  }
  LS.set('one_vToday', vToday);

  // ---------- state ----------
  let goal = LS.get('one_goal','');
  let entries = LS.get('one_entries', []); // [{date:'yyyy-mm-dd', line:'text'}]

  // ---------- elements ----------
  const goalCard = document.getElementById('goalCard');
  const goalInput = document.getElementById('goalInput');
  const saveGoal = document.getElementById('saveGoal');

  const dailyCard = document.getElementById('dailyCard');
  const goalLabel = document.getElementById('goalLabel');
  const lineInput = document.getElementById('lineInput');
  const logBtn = document.getElementById('logBtn');

  const historyCard = document.getElementById('historyCard');
  const historyBody = document.getElementById('historyBody');

  const streakNum = document.getElementById('streakNum');
  const plural = document.getElementById('plural');
  const tick = document.getElementById('tick');

  const completeWrap = document.getElementById('completeWrap');
  const completeBtn = document.getElementById('completeBtn');

  // ---------- UI control ----------
  function hasEntry(iso){ return entries.some(e => e.date === iso); }

  function streakCount() {
    let s = 0;
    let d = vToday;
    // count backwards while entries exist
    while (hasEntry(d)) { s++; d = addDays(d, -1); }
    return s;
  }

  function renderStreak(pop=false){
    const s = streakCount();
    streakNum.textContent = s;
    plural.textContent = (s === 1) ? '' : 's';
    if (pop) { tick.classList.add('pop'); setTimeout(()=>tick.classList.remove('pop'), 180); }
  }

  function renderHistory() {
    // only show previous days up to yesterday (including gaps)
    if (entries.length === 0) { historyCard.style.display = 'none'; return; }

    const datesWithLines = new Map(entries.map(e => [e.date, e.line]));
    const first = entries.map(e=>e.date).sort()[0];
    const last = addDays(vToday, -1); // up to yesterday

    if (!first || first > last) { historyCard.style.display='none'; return; }

    historyBody.innerHTML = '';
    // iterate from last down to first so newest previous is on top
    let cur = last;
    while (cur >= first) {
      const tr = document.createElement('tr');
      const tdDate = document.createElement('td');
      tdDate.textContent = cur;
      const tdLine = document.createElement('td');
      tdLine.textContent = datesWithLines.get(cur) ?? '';
      tr.appendChild(tdDate); tr.appendChild(tdLine);
      historyBody.appendChild(tr);
      cur = addDays(cur, -1);
    }
    historyCard.style.display = 'block';
  }

  function showShell() {
    if (!goal) {
      goalCard.style.display = 'block';
      dailyCard.style.display = 'none';
      completeWrap.style.display = 'none';
      return;
    }
    goalLabel.textContent = goal;
    goalCard.style.display = 'none';
    dailyCard.style.display = 'block';
    completeWrap.style.display = 'flex';
    renderStreak(false);

    // reveal previous days only if today's entry exists
    if (hasEntry(vToday)) renderHistory();
    else historyCard.style.display = 'none';
  }

  // ---------- events ----------
  saveGoal.onclick = () => {
    const text = (goalInput.value || '').trim();
    if (!text) { goalInput.focus(); return; }
    goal = text;
    LS.set('one_goal', goal);
    goalInput.value = '';
    showShell();
  };

  logBtn.onclick = () => {
    const line = (lineInput.value || '').trim();
    if (!line) { lineInput.focus(); return; }
    if (hasEntry(vToday)) { lineInput.value = ''; return; } // immutable
    entries.push({date: vToday, line});
    LS.set('one_entries', entries);
    lineInput.value = '';
    renderStreak(true);
    renderHistory();                // now reveal previous days
  };

  completeBtn.onclick = () => {
    if (!confirm('Mark goal complete and reset?')) return;
    LS.del('one_goal');
    LS.del('one_entries');
    goal = '';
    entries = [];
    showShell();
    historyCard.style.display='none';
  };

  // ---------- boot ----------
  showShell();
</script>
</body>
</html>
