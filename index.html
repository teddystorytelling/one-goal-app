<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>One Thing</title>
<style>
  :root{
    --bg:#0b0c0f; --panel:#0f1116; --card:#111318; --border:#1c1f27;
    --text:#e8ebf0; --muted:#a7b0bf; --accent:#2ad66c;
    --glass:rgba(255,255,255,0.06); --glass-border:rgba(255,255,255,0.12);
    --shadow:0 14px 34px rgba(0,0,0,.5);
    --radius:16px; --radius-sm:12px; --radius-xs:9px;
    --ease: cubic-bezier(.2,.8,.2,1);
    --t: 280ms var(--ease);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:
      radial-gradient(1200px 600px at 20% -10%, #19202e 0%, rgba(25,32,46,0) 60%),
      radial-gradient(1000px 500px at 120% 10%, #142033 0%, rgba(20,32,51,0) 60%),
      var(--bg);
    color:var(--text);
    font:16px/1.45 -apple-system,BlinkMacSystemFont,"SF Pro Text",Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }

  .wrap{max-width:880px;margin:46px auto 96px;padding:0 20px}

  /* Title */
  .hero{display:flex; align-items:center; gap:14px; margin-bottom:18px;}
  .dot{
    width:14px;height:14px;border-radius:50%;
    background:linear-gradient(180deg,#9ef2c2 0%, #2ad66c 100%);
    box-shadow:0 0 0 7px rgba(42,214,108,.12),0 8px 22px rgba(42,214,108,.35);
  }
  h1{
    margin:0;
    font-size: clamp(24px, 6vw, 38px);
    font-weight:800; letter-spacing:-.01em;
  }

  /* Cards */
  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0)), var(--card);
    border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:clip;
  }
  .stack{padding:20px;display:grid;gap:14px}

  /* Center goal card on page */
  .centerer{min-height:62vh; display:grid; place-items:center}

  /* Section header */
  .section-head{display:flex; align-items:center; justify-content:space-between; padding: 2px 2px 8px; font-weight:700;}

  /* Input + Neon button */
  .row{display:grid;grid-template-columns:1fr auto;gap:12px}
  @media (max-width:560px){ .row{grid-template-columns:1fr} }

  .input-wrap{position:relative}
  .onething{
    width:100%; padding:16px 16px;
    background:#0d0f13; border:1px solid var(--border); border-radius:var(--radius-sm);
    color:var(--text); font-size:16px; outline:none;
    transition:border-color .2s, box-shadow .2s;
  }
  .onething:focus{border-color:#2ad66c80; box-shadow:0 0 0 6px rgba(42,214,108,.1)}

  /* Karaoke placeholder overlay (slower) */
  .karaoke{
    position:absolute; inset:0; display:flex; align-items:center; overflow:hidden;
    pointer-events:none; padding:0 16px; color:#8bb39e;
    opacity:.9; white-space:nowrap; mask-image: linear-gradient(to right, transparent 0, #000 24px, #000 calc(100% - 24px), transparent 100%);
  }
  .karaoke span{ display:inline-block; animation: marquee 18s linear infinite; }
  @keyframes marquee{ 0%{ transform: translateX(0%) } 100%{ transform: translateX(-100%) } }
  .hidden{display:none !important}

  .btn{
    padding:14px 18px;
    background:linear-gradient(180deg,#46ef88,var(--accent));
    border:1px solid #32dc77; color:#05120b; font-weight:800;
    border-radius:var(--radius-sm); cursor:pointer;
    box-shadow:
      0 0 16px rgba(42,214,108,.45),
      0 8px 24px rgba(42,214,108,.35),
      inset 0 1px 0 rgba(255,255,255,.18);
    transition: transform .06s, filter .2s, box-shadow .2s;
  }
  .btn:active{ transform: translateY(1px); filter: brightness(.96) }
  .btn[disabled]{opacity:.55; cursor:default}

  /* Views with iPad-like slide/fade */
  .view{display:none; opacity:0; transform:translateX(14px); transition: opacity var(--t), transform var(--t)}
  .view.active{display:block; opacity:1; transform:translateX(0)}
  .view.exiting{opacity:0; transform:translateX(-12px)}

  /* Table (revealed only after today’s log) */
  .table{ width:100%; border-collapse:separate; border-spacing:0; margin-top:8px; }
  .table thead th{
    text-align:left; font-size:12px; color:var(--muted); padding:12px 14px;
    position:sticky; top:0; backdrop-filter: blur(8px);
    background: rgba(15,17,22,0.9);
  }
  .table tbody tr{ border-top:1px solid var(--border) }
  .table td{ padding:14px; vertical-align:top }
  .td-date{ width:160px; color:var(--muted); white-space:nowrap }
  .td-text{ width:auto }
  .empty{ padding:24px 18px; color:var(--muted); border-top:1px solid var(--border) }
  .hidden-block{ display:none }

  .goal-complete-wrap{ padding: 14px 18px 18px; display:flex; justify-content:flex-end }
  .btn-ghost{
    padding:12px 14px;border:1px solid var(--glass-border);border-radius:12px;background:var(--glass);
    color:var(--text);font-weight:600;cursor:pointer; transition: filter .2s
  }
  .btn-ghost:active{ filter:brightness(.92) }

  /* Footer (Apple-luxury glass) — only on table page when revealed */
  footer{
    display:none; position:fixed; left:0; right:0; bottom:0; padding:12px 14px;
    background:rgba(8,12,18,.55);
    backdrop-filter: blur(18px) saturate(120%); -webkit-backdrop-filter: blur(18px) saturate(120%);
    border-top:1px solid rgba(255,255,255,.12);
    box-shadow: 0 -2px 24px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
  }
  .footer-inner{max-width:880px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;color:#cfd6e3;font-size:13px;letter-spacing:.01em}
  .settings-link{ padding:7px 12px; border:1px solid var(--glass-border); border-radius:10px; background:var(--glass) }

  /* Celebration overlay (Goal Complete) */
  .overlay{
    position:fixed; inset:0; display:none; place-content:center; z-index:60;
    background:rgba(5,8,12,.72); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px);
    opacity:0; transform:scale(.98); transition: opacity 240ms var(--ease), transform 240ms var(--ease);
  }
  .overlay.show{ display:grid; opacity:1; transform:scale(1) }
  .cele-card{
    width:min(900px,92vw);
    background: linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02)), var(--panel);
    border:1px solid var(--glass-border); border-radius:24px; box-shadow:0 30px 80px rgba(0,0,0,.6); overflow:hidden;
  }
  .cele-hero{ padding:28px 22px 18px; text-align:center; position:relative }
  .bigtick{ font-size:60px; filter: drop-shadow(0 10px 28px rgba(42,214,108,.55)) }
  .cele-title{ margin:10px 0 4px; font-size:26px; font-weight:900; letter-spacing:-.01em }
  .cele-sub{ color:var(--muted); font-size:14px }
  .cele-actions{ display:flex; justify-content:center; gap:12px; padding:16px }
  .confetti{ position:absolute; inset:0; pointer-events:none; overflow:hidden }
  .confetti i{
    position:absolute; width:8px; height:14px; opacity:.95; border-radius:3px;
    background: linear-gradient(180deg,#fff,rgba(255,255,255,.7));
    animation: fall 1200ms ease-in forwards;
  }
  @keyframes fall{ to{ transform:translateY(280px) rotate(240deg); opacity:0 } }

  /* Read-only archive inside celebration */
  .cele-archive{
    max-height:min(44vh,420px); overflow:auto; border-top:1px solid var(--border);
    background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0));
  }
  .cele-archive table{ width:100%; border-collapse:separate; border-spacing:0 }
  .cele-archive th, .cele-archive td{ padding:12px 14px; text-align:left }
  .cele-archive thead th{ position:sticky; top:0; background:#0f1116d9; backdrop-filter:blur(6px); color:var(--muted); font-size:12px }
  .cele-archive tbody tr{ border-top:1px solid var(--border) }

  /* Streak overlay (gated) */
  .streak-pills{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; max-width:720px; margin: 10px auto 0 }
  .pill{
    padding:10px 14px; border-radius:999px;
    background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.03));
    border:1px solid var(--glass-border);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.06), 0 8px 22px rgba(0,0,0,.28);
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    font-size:18px
  }

  /* Settings view */
  .settings-card{ padding:18px }
  .section-title{ margin:4px 0 10px; font-size:18px; font-weight:700 }
  .danger{ background:linear-gradient(180deg,#ff7b7b,#ff5252); border-color:#ff6b6b; color:#1b0b0b; box-shadow:0 6px 18px rgba(255,105,105,.35) }

  /* Sign-up collapsible */
  .collapse{ border:1px solid var(--border); border-radius: var(--radius); overflow:hidden; }
  .collapse-head{
    display:flex; align-items:center; justify-content:space-between; padding:14px 16px; cursor:pointer;
    background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0));
  }
  .collapse-head h4{ margin:0; font-size:16px }
  .collapse-body{
    max-height:0; overflow:hidden; transition:max-height 340ms var(--ease);
    background: var(--panel); border-top:1px solid var(--border);
  }
  .collapse.open .collapse-body{ max-height:560px }

  .field{display:flex;flex-direction:column;gap:8px;margin:12px 16px}
  .input{width:100%;padding:14px;background:#0c0e12;border:1px solid var(--border);border-radius:var(--radius-xs);color:var(--text)}
  .consent{
    display:flex;align-items:center;gap:10px;cursor:pointer;margin:12px 16px 4px;
    padding:10px 12px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
    border:1px solid var(--glass-border);box-shadow:inset 0 1px 0 rgba(255,255,255,.07);user-select:none
  }
  .consent input{accent-color:#38dd7d;width:18px;height:18px}
  .pretend{margin:10px 16px 16px;color:var(--muted);font-size:13px;padding:10px 12px;background:#0c1016;border:1px dashed var(--border);border-radius:10px;display:none}
</style>
</head>
<body>

<div class="wrap">
  <div class="hero">
    <div class="dot"></div>
    <h1>One thing you have to do…</h1>
  </div>

  <!-- GOAL SETUP (first-time) -->
  <div id="view-goal" class="view active">
    <div class="centerer">
      <div class="card">
        <div class="stack">
          <div class="section-head">What’s your one goal?</div>
          <div class="row">
            <div class="input-wrap">
              <input id="goalInput" class="onething" type="text" autocomplete="off">
              <div id="goalKaraoke" class="karaoke"><span></span></div>
            </div>
            <button id="saveGoalBtn" class="btn">Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ACTIONS (daily) -->
  <div id="view-actions" class="view">
    <div class="card">
      <div class="stack">
        <div class="section-head" id="goalLabel"></div>
        <div id="actionInputRow" class="row">
          <div class="input-wrap">
            <input id="actionInput" class="onething" type="text" autocomplete="off" placeholder="What’s the one thing you did toward your goal?">
          </div>
          <button id="logActionBtn" class="btn">Log Action</button>
        </div>
      </div>

      <div id="tableBlock" class="hidden-block">
        <table class="table" id="logTable">
          <thead>
            <tr><th class="td-date">Date</th><th class="td-text">Actions toward this goal</th></tr>
          </thead>
        <tbody id="logBody">
          <tr id="emptyRow"><td colspan="2" class="empty">No actions yet. Log your first one above.</td></tr>
        </tbody>
        </table>

        <div class="goal-complete-wrap">
          <button id="completeGoalBtn" class="btn-ghost">Goal complete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ACHIEVEMENTS (celebration path only) -->
  <div id="view-achievements" class="view">
    <div class="card" style="padding:18px;">
      <h3 class="section-title">Achievements</h3>
      <div id="achievementsList" class="subtitle">No completed goals yet.</div>
      <div style="margin-top:10px;"><button id="achBackBtn" class="btn-ghost">Back</button></div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="view-settings" class="view">
    <div class="card settings-card">
      <h3 class="section-title">Settings</h3>
      <button id="deactivateBtn" class="btn danger">Deactivate account (clear all)</button>

      <div class="collapse" id="signupCollapse" style="margin-top:16px;">
        <div class="collapse-head" id="signupHead">
          <h4>Sign up</h4><span id="signupChevron">▸</span>
        </div>
        <div class="collapse-body" id="signupBody">
          <div class="field"><label>Name</label><input id="name" class="input" type="text" placeholder="Your name"></div>
          <div class="field"><label>Email</label><input id="email" class="input" type="email" placeholder="you@example.com"></div>
          <div class="field"><label>Password</label><input id="pass" class="input" type="password" placeholder="••••••••"></div>
          <div class="field"><label>Confirm password</label><input id="confirm" class="input" type="password" placeholder="••••••••"></div>
          <label class="consent"><input id="consent" type="checkbox"><span>I agree to data protection & privacy terms.</span></label>
          <div style="padding:0 16px 16px;"><button id="signupBtn" class="btn" style="width:100%;">Create account</button></div>
          <div id="pretendBlock" class="pretend">✅ Pretend: a magic link was just “sent”. We’re not sending emails in this prototype.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- FOOTER (only on actions table page when revealed) -->
<footer id="footer">
  <div class="footer-inner">
    <span>Teddy Storytelling</span>
    <a id="openSettings" class="settings-link" href="javascript:void(0)">Settings</a>
  </div>
</footer>

<!-- CELEBRATION OVERLAY -->
<div id="celebrate" class="overlay" aria-modal="true" role="dialog">
  <div class="cele-card">
    <div class="cele-hero">
      <div class="confetti" id="confetti1"></div>
      <div class="bigtick">✅</div>
      <div class="cele-title">Goal completed!</div>
      <div id="celeGoal" class="cele-sub"></div>
    </div>
    <div class="cele-archive">
      <table>
        <thead><tr><th style="width:160px">Date</th><th>Actions for this goal</th></tr></thead>
        <tbody id="celeBody"></tbody>
      </table>
    </div>
    <div class="cele-actions">
      <button id="viewAchievementsBtn" class="btn">View Achievements</button>
      <button id="closeCeleBtn" class="btn-ghost">Close</button>
    </div>
  </div>
</div>

<!-- STREAK OVERLAY -->
<div id="streakGate" class="overlay" aria-modal="true" role="dialog">
  <div class="cele-card">
    <div class="cele-hero">
      <div class="confetti" id="confetti2"></div>
      <div class="bigtick">✅</div>
      <div class="cele-title">Streak updated</div>
      <div id="streakLabel" class="cele-sub"></div>
      <div class="streak-pills" id="streakPills"></div>
    </div>
    <div class="cele-actions"><button id="closeStreakBtn" class="btn-ghost">Close</button></div>
  </div>
</div>

<script>
/* ================= Storage Keys ================= */
const K = {
  GOAL: 'ot.goal',
  ACTIONS: 'ot.actions',
  STREAK: 'ot.streak',
  LAST_ACTION: 'ot.lastAction',
  ACH: 'ot.achievements',
  FOOTER: 'ot.footer',
  SIM_DAY: 'ot.simDay'
};

/* ================= Simulated day (each refresh = +1 day) ================= */
function realTodayISO(){ return new Date().toISOString().slice(0,10); }
function isoPlusDays(iso, days){ const d = new Date(iso+'T00:00:00'); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10); }
function initSimDay(){
  let sim = localStorage.getItem(K.SIM_DAY);
  if(!sim){ sim = realTodayISO(); } else { sim = isoPlusDays(sim, 1); }
  localStorage.setItem(K.SIM_DAY, sim); return sim;
}
let SIM_TODAY = initSimDay();
function todayISO(){ return SIM_TODAY; }
function yISO(){ const d = new Date(SIM_TODAY+'T00:00:00'); d.setDate(d.getDate()-1); return d.toISOString().slice(0,10); }

/* ================= Utilities ================= */
const fmt = iso => new Date(iso+'T00:00:00').toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric',year:'numeric'});
const load = (k,def)=> { try{ const v=JSON.parse(localStorage.getItem(k)); return v??def; }catch{ return def; } };
const save = (k,v)=> localStorage.setItem(k, JSON.stringify(v));

/* ================= DOM refs ================= */
const views = {
  goal:  document.getElementById('view-goal'),
  act:   document.getElementById('view-actions'),
  ach:   document.getElementById('view-achievements'),
  set:   document.getElementById('view-settings')
};
let currentView = 'goal';
function switchView(to){
  if(to===currentView) return;
  const cur = views[currentView], nxt = views[to]||views.goal;
  if(cur){ cur.classList.add('exiting'); setTimeout(()=>{ cur.classList.remove('active','exiting'); }, 150); }
  nxt.classList.add('active');
  currentView = to;
  showFooterIfNeeded();
}

/* Goal setup */
const goalInput = document.getElementById('goalInput');
const saveGoalBtn = document.getElementById('saveGoalBtn');
const goalKaraoke = document.getElementById('goalKaraoke');
const karaokeSpan = goalKaraoke.querySelector('span');

/* Actions view */
const actionInputRow = document.getElementById('actionInputRow');
const actionInput = document.getElementById('actionInput');
const logActionBtn = document.getElementById('logActionBtn');
const goalLabel = document.getElementById('goalLabel');
const tableBlock = document.getElementById('tableBlock');
const logBody = document.getElementById('logBody');

/* Footer / Settings */
const footer = document.getElementById('footer');
const openSettings = document.getElementById('openSettings');
const deactivateBtn = document.getElementById('deactivateBtn');

/* Settings → Sign-up collapse */
const signupCollapse = document.getElementById('signupCollapse');
const signupHead = document.getElementById('signupHead');
const signupChevron = document.getElementById('signupChevron');
const signupBtn = document.getElementById('signupBtn');
const pretendBlock = document.getElementById('pretendBlock');

/* Celebration (Goal Complete) overlay */
const celebrate = document.getElementById('celebrate');
const celeBody = document.getElementById('celeBody');
const celeGoal = document.getElementById('celeGoal');
const confetti1 = document.getElementById('confetti1');
const closeCeleBtn = document.getElementById('closeCeleBtn');
const viewAchievementsBtn = document.getElementById('viewAchievementsBtn');

/* Streak overlay */
const streakGate = document.getElementById('streakGate');
const confetti2 = document.getElementById('confetti2');
const streakLabel = document.getElementById('streakLabel');
const streakPills = document.getElementById('streakPills');
const closeStreakBtn = document.getElementById('closeStreakBtn');

/* ================= Placeholder rotation (goal) ================= */
const examples = [
  "Close a £200k sale",
  "Tell a loved one one thing you appreciate about them",
  "Run 5 kilometers this week"
];
function setKaraokeText(){ const text = examples[Math.floor(Math.random()*examples.length)]; karaokeSpan.textContent = ` ${text} \u00A0\u00A0\u00A0 ${text} \u00A0\u00A0\u00A0 ${text} `; }
function toggleKaraoke(){ const show = !goalInput.value.trim() && document.activeElement !== goalInput; goalKaraoke.classList.toggle('hidden', !show); }

/* ================= Render helpers ================= */
function renderGoalLabel(){ const g = load(K.GOAL, null); goalLabel.textContent = g ? `Goal: ${g.text}` : ''; }
function hasLoggedToday(actions){ return actions.some(a=> a.date === todayISO()); }
function renderActionsTable(){
  const actions = load(K.ACTIONS, []);
  logBody.innerHTML = '';
  if(!actions.length){
    const tr = document.createElement('tr'); const td = document.createElement('td');
    td.colSpan = 2; td.className='empty'; td.textContent = 'No actions yet. Log your first one above.';
    tr.appendChild(td); logBody.appendChild(tr); return;
  }
  const sorted = actions.sort((a,b)=> (a.date===b.date ? (a.time>b.time?-1:1) : (a.date<b.date?1:-1)));
  sorted.forEach(x=>{
    const tr = document.createElement('tr');
    const td1 = document.createElement('td'); td1.className='td-date'; td1.textContent = fmt(x.date);
    const td2 = document.createElement('td'); td2.className='td-text'; td2.textContent = x.text;
    tr.appendChild(td1); tr.appendChild(td2); logBody.appendChild(tr);
  });
}
function refreshActionsViewReveal(){
  const actions = load(K.ACTIONS, []);
  const todayDone = hasLoggedToday(actions);
  if(todayDone){
    actionInputRow.style.display = 'none';
    tableBlock.classList.remove('hidden-block');
  }else{
    actionInputRow.style.display = '';
    tableBlock.classList.add('hidden-block');
  }
  showFooterIfNeeded();
}

/* ================= Confetti ================= */
function spawnConfetti(box, n=42){
  box.innerHTML=''; const W = box.clientWidth||800;
  for(let i=0;i<n;i++){
    const iel = document.createElement('i');
    iel.style.left = (Math.random()*W) + 'px';
    iel.style.top = (-Math.random()*140) + 'px';
    iel.style.transform = `rotate(${Math.random()*180}deg)`;
    iel.style.animationDelay = (Math.random()*0.5)+'s';
    iel.style.background = Math.random()>.5
      ? 'linear-gradient(180deg,#9ef2c2,#2ad66c)'
      : 'linear-gradient(180deg,#c6d1ff,#7ca8ff)';
    box.appendChild(iel);
  }
}

/* ================= Streak logic ================= */
function updateStreakOnAction(){
  const last = localStorage.getItem(K.LAST_ACTION);
  const today = todayISO();
  let streak = load(K.STREAK, 0);
  if(!last){ streak = 1; }
  else if(last === today){ /* same day, unchanged */ }
  else if(last === yISO()){ streak = streak + 1; }
  else { streak = 1; }
  save(K.STREAK, streak);
  localStorage.setItem(K.LAST_ACTION, today);
  return streak;
}

/* ================= Overlays ================= */
function openCelebration(goal, actions){
  celeGoal.textContent = goal ? goal.text : '';
  celeBody.innerHTML='';
  actions.sort((a,b)=> (a.date===b.date ? (a.time>b.time?-1:1) : (a.date<b.date?1:-1)))
    .forEach(x=>{
      const tr=document.createElement('tr');
      const td1=document.createElement('td'); td1.textContent=fmt(x.date);
      const td2=document.createElement('td'); td2.textContent=x.text;
      tr.appendChild(td1); tr.appendChild(td2); celeBody.appendChild(tr);
    });
  spawnConfetti(confetti1);
  celebrate.classList.add('show');
}
function closeCelebration(){ celebrate.classList.remove('show'); setTimeout(()=>{ celeBody.innerHTML=''; confetti1.innerHTML=''; },240); }
function openStreakGate(streak){
  streakLabel.textContent = `Current streak: ${streak} day${streak===1?'':'s'}`;
  streakPills.innerHTML=''; for(let i=0;i<streak;i++){ const d=document.createElement('div'); d.className='pill'; d.textContent='✅'; streakPills.appendChild(d); }
  spawnConfetti(confetti2, 30); streakGate.classList.add('show');
}
function closeStreakGate(){ streakGate.classList.remove('show'); setTimeout(()=>{ confetti2.innerHTML=''; streakPills.innerHTML=''; },240); }

/* ================= Actions ================= */
document.getElementById('saveGoalBtn').addEventListener('click', ()=>{
  const text = goalInput.value.trim();
  if(!text){ alert('Please enter your one goal.'); return; }
  const goal = { text, createdAt: new Date().toISOString() };
  save(K.GOAL, goal); save(K.ACTIONS, []);
  renderGoalLabel(); renderActionsTable();
  switchView('act'); refreshActionsViewReveal();
});

document.getElementById('logActionBtn').addEventListener('click', ()=>{
  const text = actionInput.value.trim(); if(!text){ return; }
  const actions = load(K.ACTIONS, []);
  if(actions.some(a=> a.date === todayISO())){ refreshActionsViewReveal(); return; }
  const entry = { date: todayISO(), text, time: new Date().toISOString() };
  actions.push(entry); save(K.ACTIONS, actions);
  actionInput.value=''; renderActionsTable(); refreshActionsViewReveal();

  localStorage.setItem(K.FOOTER,'1'); // allow footer
  const streak = updateStreakOnAction(); if(streak >= 2){ openStreakGate(streak); }
});

document.getElementById('completeGoalBtn').addEventListener('click', ()=>{
  const goal = load(K.GOAL, null); if(!goal){ alert('No active goal to complete.'); return; }
  const actions = load(K.ACTIONS, []); goal.completedAt = new Date().toISOString();
  const ach = load(K.ACH, []); ach.push({ goal, actions }); save(K.ACH, ach);
  openCelebration(goal, actions);
});

document.getElementById('closeCeleBtn').addEventListener('click', ()=>{
  save(K.GOAL, null); save(K.ACTIONS, []); closeCelebration();
  switchView('goal'); setKaraokeText(); toggleKaraoke();
});
document.getElementById('viewAchievementsBtn').addEventListener('click', ()=>{
  save(K.GOAL, null); save(K.ACTIONS, []); closeCelebration();
  const ach = load(K.ACH, []); const box = document.getElementById('achievementsList');
  if(!ach.length){ box.textContent = 'No completed goals yet.'; }
  else{
    const html = ach.slice().reverse().map(item=>{
      const g = item.goal;
      const list = item.actions.map(a=>`<li><strong>${fmt(a.date)}</strong> — ${a.text}</li>`).join('');
      return `
        <div style="border:1px solid var(--border); border-radius:12px; padding:12px; margin:10px 0;
                    background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0))">
          <div style="font-weight:700; margin-bottom:6px;">${g.text}</div>
          <div class="subtitle" style="margin:0 0 8px;">${fmt(g.createdAt.slice(0,10))} → ${fmt(g.completedAt.slice(0,10))}</div>
          <ul style="margin:0; padding-left:18px">${list}</ul>
        </div>
      `;
    }).join('');
    box.innerHTML = html;
  }
  switchView('ach');
});

/* settings */
document.getElementById('openSettings').addEventListener('click', ()=> switchView('set'));
deactivateBtn.addEventListener('click', ()=>{
  if(confirm('Deactivate account and clear all data?')){
    Object.values(K).forEach(k=> localStorage.removeItem(k));
    SIM_TODAY = initSimDay();
    switchView('goal'); goalInput.value=''; actionInput.value='';
    renderActionsTable(); renderGoalLabel(); setKaraokeText(); toggleKaraoke();
    footer.style.display='none'; alert('All cleared. Fresh start.');
  }
});

/* sign-up collapsible */
let collapseOpen = false;
function toggleSignup(){ collapseOpen = !collapseOpen; signupCollapse.classList.toggle('open', collapseOpen); signupChevron.textContent = collapseOpen ? '▾' : '▸'; }
signupHead.addEventListener('click', toggleSignup);
signupBtn.addEventListener('click', ()=>{
  const name = document.getElementById('name').value.trim();
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('pass').value;
  const confirm = document.getElementById('confirm').value;
  const consent = document.getElementById('consent').checked;
  if(!name || !email || !pass || !confirm){ alert('Please complete all fields.'); return; }
  if(pass !== confirm){ alert('Passwords do not match.'); return; }
  if(!consent){ alert('Please tick the data protection consent.'); return; }
  localStorage.setItem('ot.user', JSON.stringify({name,email}));
  pretendBlock.style.display='block';
});

/* streak overlay close */
closeStreakBtn.addEventListener('click', closeStreakGate);

/* goal karaoke behavior */
goalInput.addEventListener('focus', toggleKaraoke);
goalInput.addEventListener('blur', toggleKaraoke);
goalInput.addEventListener('input', toggleKaraoke);

/* ================= Footer display logic ================= */
function showFooterIfNeeded(){
  // Only on actions view AND only when the table is revealed for today
  const allowed = currentView === 'act' && !tableBlock.classList.contains('hidden-block');
  const has = localStorage.getItem(K.FOOTER)==='1';
  footer.style.display = (allowed && has) ? 'block' : 'none';
}

/* ================= Init ================= */
(function init(){
  const g = load(K.GOAL, null);
  if(g){ renderGoalLabel(); renderActionsTable(); switchView('act'); refreshActionsViewReveal(); }
  else { views.goal.classList.add('active'); currentView='goal'; }

  setKaraokeText(); toggleKaraoke();
  showFooterIfNeeded();
})();
</script>
</body>
</html>